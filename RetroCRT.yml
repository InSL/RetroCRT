---

##############################################################################
# This file is part of RetroCRT (https://github.com/xovox/RetroCRT)
#
# RetroCRT is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# RetroCRT is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with RetroCRT.  If not, see <https://www.gnu.org/licenses/>.
##############################################################################

- hosts: "localhost"
  connection: "local"
  become: "yes"
  become_user: "root"

  handlers:

    - name: "Install Updated /boot Configs"
      copy:
        src: "/{{ item }}"
        dest: "/boot/{{ item }}"
      with_items:
        - "cmdline.txt"
        - "config.txt"
      listen: "copyboot"

  pre_tasks:

    - name: "Reading Configs"
      set_fact:
        tv_region: "{{ lookup('env', 'tv_region') }}"
        retrocrt_timings: "{{ lookup('env', 'retrocrt_timings') }}"
        rotate_tv: "{{ lookup('env', 'rotate_tv') }}"
        rotate_es: "{{ lookup('env', 'rotate_es') }}"
        rotate_ra: "{{ lookup('env', 'rotate_ra') }}"
        home_dir: "{{ lookup('env', 'HOME') }}"
        #physical_viewport_width: "{{ lookup('env', 'physical_viewport_width') }}"
        #physical_viewport_height: "{{ lookup('env', 'physical_viewport_height') }}"
        #physical_viewport_width: "{{ lookup('env', 'physical_viewport_width') }}"
        physical_viewport_width: 1920
        physical_viewport_height: 240
        virtual_viewport_width: 320
        handheld_multiplier: 6

    - name: "Set Default Timings"
      set_fact:
        default_timings: "{{ lookup('file', '{{ retrocrt_timings }}/default') }}"
        
    - name: "Find / UUID"
      command: "findmnt --noheadings --output PARTUUID /"
      register: root_uuid

    - name: "Find / Filesystem Type"
      command: "findmnt --noheadings --output FSTYPE /"
      register: root_fstype

    - name: "Check State of Test ROMS"
      stat:
        path: "{{home_dir}}/RetroPie/roms/.240p_copied"
      register: roms_copied

    - name: "Resolution: Get 4:3 Vertical"
      set_fact:
        arcade_custom_viewport_height: 240
        atari2600_custom_viewport_height: 210
        atari5200_custom_viewport_height: 240
        atari7800_custom_viewport_height: 240
        fba_custom_viewport_height: 240
        fds_custom_viewport_height: 224
        mame_libretro_custom_viewport_height: 240
        mastersystem_custom_viewport_height: 192
        megadrive_custom_viewport_height: 224
        msx_custom_viewport_height: 240
        n64_custom_viewport_height: 480
        neogeo_custom_viewport_height: 224
        nes_custom_viewport_height: 224
        pcengine_custom_viewport_height: 240
        psx_custom_viewport_height: 240
        sega32x_custom_viewport_height: 224
        segacd_custom_viewport_height: 224
        snes_custom_viewport_height: 224

#    - name: "Resolution: Handheld Multiplier"
#      set_fact:
#        handheld_multiplier: "{{ (physical_viewport_width / virtual_viewport_width) | int }}"

    - name: "Resolution: Get Handheld"
      set_fact:
        atarilynx_custom_viewport_width: 160
        atarilynx_custom_viewport_height: 102
        gamegear_custom_viewport_width: 160
        gamegear_custom_viewport_height: 144
        gba_custom_viewport_width: 240
        gba_custom_viewport_height: 160
        gbc_custom_viewport_width: 160
        gbc_custom_viewport_height: 144
        gb_custom_viewport_width: 160
        gb_custom_viewport_height: 144
        ngpc_custom_viewport_width: 160
        ngpc_custom_viewport_height: 152
        ngp_custom_viewport_width: 160
        ngp_custom_viewport_height: 152
        virtualboy_custom_viewport_width: 384
        virtualboy_custom_viewport_height: 224
        wonderswancolor_custom_viewport_width: 224
        wonderswancolor_custom_viewport_height: 144
        wonderswan_custom_viewport_width: 224
        wonderswan_custom_viewport_height: 144

    - name: "Resolution: Find 4:3 Multiplier"
      set_fact:
        arcade_custom_viewport_percentage: "{{ arcade_custom_viewport_height / physical_viewport_height | float }}"
        atari2600_custom_viewport_percentage: "{{ atari2600_custom_viewport_height / physical_viewport_height | float }}"
        atari5200_custom_viewport_percentage: "{{ atari5200_custom_viewport_height / physical_viewport_height | float }}"
        atari7800_custom_viewport_percentage: "{{ atari7800_custom_viewport_height / physical_viewport_height | float }}"
        fba_custom_viewport_percentage: "{{ fba_custom_viewport_height / physical_viewport_height | float }}"
        fds_custom_viewport_percentage: "{{ fds_custom_viewport_height / physical_viewport_height | float }}"
        mame_libretro_custom_viewport_percentage: "{{ mame_libretro_custom_viewport_height / physical_viewport_height | float }}"
        mastersystem_custom_viewport_percentage: "{{ mastersystem_custom_viewport_height / physical_viewport_height | float }}"
        megadrive_custom_viewport_percentage: "{{ megadrive_custom_viewport_height / physical_viewport_height | float }}"
        msx_custom_viewport_percentage: "{{ msx_custom_viewport_height / physical_viewport_height | float }}"
        n64_custom_viewport_percentage: "{{ n64_custom_viewport_height / physical_viewport_height | float }}"
        neogeo_custom_viewport_percentage: "{{ neogeo_custom_viewport_height / physical_viewport_height | float }}"
        nes_custom_viewport_percentage: "{{ nes_custom_viewport_height / physical_viewport_height | float }}"
        pcengine_custom_viewport_percentage: "{{ pcengine_custom_viewport_height / physical_viewport_height | float }}"
        psx_custom_viewport_percentage: "{{ psx_custom_viewport_height / physical_viewport_height | float }}"
        sega32x_custom_viewport_percentage: "{{ sega32x_custom_viewport_height / physical_viewport_height | float }}"
        segacd_custom_viewport_percentage: "{{ segacd_custom_viewport_height / physical_viewport_height | float }}"
        snes_custom_viewport_percentage: "{{ snes_custom_viewport_height / physical_viewport_height | float }}"

    - name: "Resolution: Calc 4:3 Horizontal"
      set_fact:
        arcade_custom_viewport_width: "{{ (physical_viewport_width * arcade_custom_viewport_percentage | float) | int}}"
        atari2600_custom_viewport_width: "{{ (physical_viewport_width * atari2600_custom_viewport_percentage | float) | int}}"
        atari5200_custom_viewport_width: "{{ (physical_viewport_width * atari5200_custom_viewport_percentage | float) | int}}"
        atari7800_custom_viewport_width: "{{ (physical_viewport_width * atari7800_custom_viewport_percentage | float) | int}}"
        fba_custom_viewport_width: "{{ (physical_viewport_width * fba_custom_viewport_percentage | float) | int}}"
        fds_custom_viewport_width: "{{ (physical_viewport_width * fds_custom_viewport_percentage | float) | int}}"
        mame_libretro_custom_viewport_width: "{{ (physical_viewport_width * mame_libretro_custom_viewport_percentage | float) | int}}"
        mastersystem_custom_viewport_width: "{{ (physical_viewport_width * mastersystem_custom_viewport_percentage | float) | int}}"
        megadrive_custom_viewport_width: "{{ (physical_viewport_width * megadrive_custom_viewport_percentage | float) | int}}"
        msx_custom_viewport_width: "{{ (physical_viewport_width * msx_custom_viewport_percentage | float) | int}}"
        n64_custom_viewport_width: "{{ (physical_viewport_width * n64_custom_viewport_percentage | float) | int}}"
        neogeo_custom_viewport_width: "{{ (physical_viewport_width * neogeo_custom_viewport_percentage | float) | int}}"
        nes_custom_viewport_width: "{{ (physical_viewport_width * nes_custom_viewport_percentage | float) | int}}"
        pcengine_custom_viewport_width: "{{ (physical_viewport_width * pcengine_custom_viewport_percentage | float) | int}}"
        psx_custom_viewport_width: "{{ (physical_viewport_width * psx_custom_viewport_percentage | float) | int}}"
        sega32x_custom_viewport_width: "{{ (physical_viewport_width * sega32x_custom_viewport_percentage | float) | int}}"
        segacd_custom_viewport_width: "{{ (physical_viewport_width * segacd_custom_viewport_percentage | float) | int}}"
        snes_custom_viewport_width: "{{ (physical_viewport_width * snes_custom_viewport_percentage | float) | int}}"

  tasks:

    - name: "Update /boot Configs"
      template:
        src: "templates/{{ item }}.j2"
        dest: "/{{ item }}"
      with_items:
        - "cmdline.txt"
        - "config.txt"
      notify: "copyboot"

    - name: "Update EmulationStation Startup"
      template:
        src: "templates/autostart.sh.j2"
        dest: "/opt/retropie/configs/all/autostart.sh"

    - name: "Menu Item"
      copy:
        src: "bin/RetroCRT.sh"
        dest: "{{home_dir}}/RetroPie/retropiemenu/RetroCRT.sh"
        mode: 0755
        owner: "pi"
        group: "pi"

    - name: "Menu Item Icon"
      copy:
        src: "files/RetroCRT.png"
        dest: "{{home_dir}}/RetroPie/retropiemenu/icons/RetroCRT.png"
        mode: 0644
        owner: "pi"
        group: "pi"

    - name: "Copy RetroArch Configs"
      synchronize:
        src: "configs/retropie/"
        dest: "/opt/retropie/configs/"
        rsync_opts:
          - "--backup"
          - "--suffix .{{ansible_date_time.epoch}}"

    - name: "Copy On Start/End Scripts"
      synchronize:
        src: "files/{{ item }}/"
        dest: '{{home_dir}}/RetroPie/{{ item }}/'
        rsync_opts:
          - "--backup"
          - "--suffix .{{ansible_date_time.epoch}}"
      with_items:
        - "runcommand-onstart.d"
        - "runcommand-onend.d"

    - name: "Disable RetroArch Notifications"
      lineinfile:
        dest: "/opt/retropie/configs/all/retroarch.cfg"
        backup: "yes"
        regexp: '^video_font_enable ='
        line: 'video_font_enable = "false"'

    - name: "240p Test Suite"
      synchronize:
        src: "files/roms/"
        dest: "{{home_dir}}/RetroPie/roms/"
        rsync_opts:
          - "--exclude README.md"
      when: roms_copied.stat.exists == False

    - name: "Theme: Delete Carbon"
      file:
        path: "/etc/emulationstation/themes/carbon"
        state: "absent"

    - name: "Theme: Install GBZ35 Dark"
      git:
        depth: 1
        repo: "https://github.com/rxbrad/es-theme-gbz35-dark"
        dest: "/etc/emulationstation/themes/GBZ35 Dark"

    - name: "Theme: Install Push A"
      git:
        depth: 1
        repo: "https://github.com/asche76/es-theme-push-a"
        dest: "/etc/emulationstation/themes/Push A"

    - name: "Auto-Login Symlink"
      file:
        src: "/etc/systemd/system/autologin@.service"
        dest: "/etc/systemd/system/getty.target.wants/getty@tty1.service"
        owner: "root"
        group: "root"
        state: "link"
        force: "yes"
        
    - name: "Fix Permissions"
      file:
        path: "{{ item }}"
        state: "directory"
        owner: "pi"
        group: "pi"
        recurse: "yes"
      with_items:
        - "/opt/retropie"
        - "{{home_dir}}"

    - name: "Configure RetroArch"
      blockinfile:
        dest: '/opt/retropie/configs/all/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        block: |
                aspect_ratio_index = 23
                video_fullscreen = true
                video_hard_sync = true
                video_refresh_rate = 59.73
                video_scale_integer = true
                video_smooth = false
                video_threaded = true
                video_vsync = true

    - name: "Configure Arcade"
      blockinfile:
        dest: '/opt/retropie/configs/arcade/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ arcade_custom_viewport_width }}
          custom_viewport_height = {{ arcade_custom_viewport_height }}

    - name: "Configure Atari Lynx"
      blockinfile:
        dest: '/opt/retropie/configs/atarilynx/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ atarilynx_custom_viewport_width * handheld_multiplier }}
          custom_viewport_height = {{ atarilynx_custom_viewport_height }}

    - name: "Configure Atari 2600"
      blockinfile:
        dest: '/opt/retropie/configs/atari2600/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ atari2600_custom_viewport_width }}
          custom_viewport_height = {{ atari2600_custom_viewport_height }}

    - name: "Configure Atari 5200"
      blockinfile:
        dest: '/opt/retropie/configs/atari5200/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ atari5200_custom_viewport_width }}
          custom_viewport_height = {{ atari5200_custom_viewport_height }}

    - name: "Configure Atari 7800"
      blockinfile:
        dest: '/opt/retropie/configs/atari7800/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ atari7800_custom_viewport_width }}
          custom_viewport_height = {{ atari7800_custom_viewport_height }}

    - name: "Configure Final Burn Neo"
      blockinfile:
        dest: '/opt/retropie/configs/fba/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ fba_custom_viewport_width }}
          custom_viewport_height = {{ fba_custom_viewport_height }}

    - name: "Configure Famicom Disk System"
      blockinfile:
        dest: '/opt/retropie/configs/fds/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ fds_custom_viewport_width }}
          custom_viewport_height = {{ fds_custom_viewport_height }}

    - name: "Configure Game Gear"
      blockinfile:
        dest: '/opt/retropie/configs/gamegear/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ gamegear_custom_viewport_width * handheld_multiplier }}
          custom_viewport_height = {{ gamegear_custom_viewport_height }}

    - name: "Configure Game Boy Advance"
      blockinfile:
        dest: '/opt/retropie/configs/gba/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ gba_custom_viewport_width * handheld_multiplier }}
          custom_viewport_height = {{ gba_custom_viewport_height }}

    - name: "Configure Game Boy Color"
      blockinfile:
        dest: '/opt/retropie/configs/gbc/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ gbc_custom_viewport_width * handheld_multiplier }}
          custom_viewport_height = {{ gbc_custom_viewport_height }}

    - name: "Configure Game Boy"
      blockinfile:
        dest: '/opt/retropie/configs/gb/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ gb_custom_viewport_width * handheld_multiplier }}
          custom_viewport_height = {{ gb_custom_viewport_height }}

    - name: "Configure MAME"
      blockinfile:
        dest: '/opt/retropie/configs/mame-libretro/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ mame_libretro_custom_viewport_width }}
          custom_viewport_height = {{ mame_libretro_custom_viewport_height }}

    - name: "Configure Master System"
      blockinfile:
        dest: '/opt/retropie/configs/mastersystem/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ mastersystem_custom_viewport_width }}
          custom_viewport_height = {{ mastersystem_custom_viewport_height }}

    - name: "Configure Mega Drive/Genesis"
      blockinfile:
        dest: '/opt/retropie/configs/megadrive/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ megadrive_custom_viewport_width }}
          custom_viewport_height = {{ megadrive_custom_viewport_height }}

    - name: "Configure MSX"
      blockinfile:
        dest: '/opt/retropie/configs/msx/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ msx_custom_viewport_width }}
          custom_viewport_height = {{ msx_custom_viewport_height }}

    - name: "Configure Nintendo 64"
      blockinfile:
        dest: '/opt/retropie/configs/n64/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ n64_custom_viewport_width }}
          custom_viewport_height = {{ n64_custom_viewport_height }}

    - name: "Configure Neo Geo"
      blockinfile:
        dest: '/opt/retropie/configs/neogeo/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ neogeo_custom_viewport_width }}
          custom_viewport_height = {{ neogeo_custom_viewport_height }}

    - name: "Configure NES"
      blockinfile:
        dest: '/opt/retropie/configs/nes/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ nes_custom_viewport_width }}
          custom_viewport_height = {{ nes_custom_viewport_height }}

    - name: "Configure Neo Geo Pocket Color"
      blockinfile:
        dest: '/opt/retropie/configs/ngpc/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ ngpc_custom_viewport_width * handheld_multiplier }}
          custom_viewport_height = {{ ngpc_custom_viewport_height }}

    - name: "Configure Neo Geo Pocket"
      blockinfile:
        dest: '/opt/retropie/configs/ngp/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ ngp_custom_viewport_width * handheld_multiplier }}
          custom_viewport_height = {{ ngp_custom_viewport_height }}

    - name: "Configure PC-Engine/TurboGrafx-16"
      blockinfile:
        dest: '/opt/retropie/configs/pcengine/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ pcengine_custom_viewport_width }}
          custom_viewport_height = {{ pcengine_custom_viewport_height }}

    - name: "Configure PlayStation"
      blockinfile:
        dest: '/opt/retropie/configs/psx/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ psx_custom_viewport_width }}
          custom_viewport_height = {{ psx_custom_viewport_height }}

    - name: "Configure Sega 32X"
      blockinfile:
        dest: '/opt/retropie/configs/sega32x/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ sega32x_custom_viewport_width }}
          custom_viewport_height = {{ sega32x_custom_viewport_height }}

    - name: "Configure Sega CD"
      blockinfile:
        dest: '/opt/retropie/configs/segacd/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ segacd_custom_viewport_width }}
          custom_viewport_height = {{ segacd_custom_viewport_height }}

    - name: "Configure Super Nintendo"
      blockinfile:
        dest: '/opt/retropie/configs/snes/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ snes_custom_viewport_width }}
          custom_viewport_height = {{ snes_custom_viewport_height }}

    - name: "Configure Virtual Boy"
      blockinfile:
        dest: '/opt/retropie/configs/virtualboy/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ virtualboy_custom_viewport_width * handheld_multiplier }}
          custom_viewport_height = {{ virtualboy_custom_viewport_height }}

    - name: "Configure WonderSwan Color"
      blockinfile:
        dest: '/opt/retropie/configs/wonderswancolor/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ wonderswancolor_custom_viewport_width * handheld_multiplier }}
          custom_viewport_height = {{ wonderswancolor_custom_viewport_height }}

    - name: "Configure WonderSwan"
      blockinfile:
        dest: '/opt/retropie/configs/wonderswan/retroarch.cfg'
        create: 'yes'
        backup: 'yes'
        insertbefore: "^#include"
        block: |
          custom_viewport_width = {{ wonderswan_custom_viewport_width * handheld_multiplier }}
          custom_viewport_height = {{ wonderswan_custom_viewport_height }}

